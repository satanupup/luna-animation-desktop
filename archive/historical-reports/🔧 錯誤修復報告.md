# ğŸ”§ ç’å¨œçš„ GIF å‹•ç•«è£½ä½œå™¨ - éŒ¯èª¤ä¿®å¾©å ±å‘Š

## ğŸš¨ ç™¼ç¾çš„å•é¡Œ

### 1. **preload.js æ¨¡çµ„è¼‰å…¥éŒ¯èª¤** âŒ
```
Error: module not found: path
ReferenceError: require is not defined
```

**å•é¡ŒåŸå› ï¼š**
- åœ¨ preload.js ä¸­ç›´æ¥ä½¿ç”¨ Node.js çš„ `require`
- Electron å®‰å…¨é™åˆ¶ä¸å…è¨±åœ¨æ¸²æŸ“ç¨‹åºä¸­ç›´æ¥å­˜å– Node.js æ¨¡çµ„
- é•åäº† Electron çš„å®‰å…¨æœ€ä½³å¯¦è¸

### 2. **FFmpeg åŠŸèƒ½ç„¡æ³•ä½¿ç”¨** âŒ
```
ffmpeg-handler.js:39 æª¢æŸ¥ FFmpeg æ™‚ç™¼ç”ŸéŒ¯èª¤: ReferenceError: require is not defined
```

**å•é¡ŒåŸå› ï¼š**
- FFmpegHandler å˜—è©¦åœ¨å‰ç«¯ç›´æ¥ä½¿ç”¨ Node.js åŠŸèƒ½
- æª”æ¡ˆç³»çµ±ã€è·¯å¾‘æ“ä½œã€å­ç¨‹åºåŸ·è¡Œéƒ½ç„¡æ³•åœ¨æ¸²æŸ“ç¨‹åºä¸­ä½¿ç”¨

### 3. **Electron å®‰å…¨è­¦å‘Š** âš ï¸
```
Electron Security Warning (Insecure Content-Security-Policy)
This renderer process has either no Content Security Policy set or a policy with "unsafe-eval" enabled.
```

**å•é¡ŒåŸå› ï¼š**
- ç¼ºå°‘ Content-Security-Policy è¨­å®š
- å­˜åœ¨å®‰å…¨é¢¨éšª

## âœ… ä¿®å¾©æ–¹æ¡ˆ

### 1. **é‡æ–°è¨­è¨ˆ preload.js æ¶æ§‹**

**ä¿®å¾©å‰ï¼š**
```javascript
// âŒ ç›´æ¥åœ¨ preload.js ä¸­ require Node.js æ¨¡çµ„
const path = require('path');
const fs = require('fs');
const os = require('os');
const { spawn } = require('child_process');

// âŒ æš´éœ²è¤‡é›œçš„ Node.js API
nodeAPI: {
  path: { join: (...args) => path.join(...args) },
  fs: { existsSync: (path) => fs.existsSync(path) },
  // ...
}
```

**ä¿®å¾©å¾Œï¼š**
```javascript
// âœ… ç°¡æ½”çš„ IPC æ¥å£
contextBridge.exposeInMainWorld('electronAPI', {
  ffmpeg: {
    checkAvailability: () => ipcRenderer.invoke('ffmpeg-check-availability'),
    createTempDirectory: () => ipcRenderer.invoke('ffmpeg-create-temp-directory'),
    saveFramesToTemp: (frames, tempDir) => ipcRenderer.invoke('ffmpeg-save-frames-to-temp', frames, tempDir),
    runCommand: (command) => ipcRenderer.invoke('ffmpeg-run-command', command),
    cleanupTempDirectory: (tempDir) => ipcRenderer.invoke('ffmpeg-cleanup-temp-directory', tempDir)
  }
});
```

### 2. **å°‡ Node.js åŠŸèƒ½ç§»åˆ°ä¸»ç¨‹åº**

**åœ¨ main.js ä¸­æ·»åŠ  IPC è™•ç†å™¨ï¼š**
```javascript
// âœ… å®‰å…¨çš„ä¸»ç¨‹åºè™•ç†
ipcMain.handle('ffmpeg-check-availability', async () => {
  try {
    const appPath = process.cwd();
    const projectFFmpegPath = path.join(appPath, 'ffmpeg-master-latest-win64-gpl-shared', 'bin', 'ffmpeg.exe');
    
    if (fs.existsSync(projectFFmpegPath)) {
      return { isAvailable: true, path: projectFFmpegPath };
    }
    return { isAvailable: false, path: null };
  } catch (error) {
    return { isAvailable: false, path: null, error: error.message };
  }
});

ipcMain.handle('ffmpeg-run-command', async (event, command) => {
  return new Promise((resolve, reject) => {
    const process = spawn('cmd', ['/c', command], { stdio: ['pipe', 'pipe', 'pipe'] });
    // ... è™•ç†ç¨‹åºåŸ·è¡Œ
  });
});
```

### 3. **ä¿®æ”¹ FFmpegHandler ä½¿ç”¨ IPC**

**ä¿®å¾©å‰ï¼š**
```javascript
// âŒ ç›´æ¥ä½¿ç”¨ Node.js API
const { path, fs, process } = window.electronAPI.nodeAPI;
const appPath = process.cwd();
const projectFFmpegPath = path.join(appPath, 'ffmpeg-master-latest-win64-gpl-shared', 'bin', 'ffmpeg.exe');
```

**ä¿®å¾©å¾Œï¼š**
```javascript
// âœ… é€šé IPC å®‰å…¨èª¿ç”¨
async checkFFmpegAvailability() {
  if (window.electronAPI && window.electronAPI.ffmpeg) {
    const result = await window.electronAPI.ffmpeg.checkAvailability();
    
    if (result.isAvailable) {
      this.ffmpegPath = result.path;
      this.isAvailable = true;
      return true;
    }
  }
  return false;
}
```

### 4. **æ·»åŠ  Content-Security-Policy**

**ä¿®å¾©å‰ï¼š**
```html
<!-- âŒ ç¼ºå°‘ CSP è¨­å®š -->
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç’å¨œçš„ GIF å‹•ç•«è£½ä½œå™¨ ğŸŒ™</title>
</head>
```

**ä¿®å¾©å¾Œï¼š**
```html
<!-- âœ… æ·»åŠ å®‰å…¨çš„ CSP è¨­å®š -->
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:;">
  <title>ç’å¨œçš„ GIF å‹•ç•«è£½ä½œå™¨ ğŸŒ™</title>
</head>
```

## ğŸ¯ ä¿®å¾©æ•ˆæœ

### âœ… å®‰å…¨æ€§æå‡

1. **ç¬¦åˆ Electron æœ€ä½³å¯¦è¸**
   - æ¸²æŸ“ç¨‹åºèˆ‡ä¸»ç¨‹åºæ­£ç¢ºåˆ†é›¢
   - é€šé IPC å®‰å…¨é€šè¨Š
   - é¿å…ç›´æ¥æš´éœ² Node.js API

2. **Content-Security-Policy ä¿è­·**
   - é˜²æ­¢ XSS æ”»æ“Š
   - é™åˆ¶ä¸å®‰å…¨çš„è…³æœ¬åŸ·è¡Œ
   - æå‡æ•´é«”å®‰å…¨æ€§

### âœ… åŠŸèƒ½æ¢å¾©

1. **FFmpeg åŠŸèƒ½æ­£å¸¸**
   - æª”æ¡ˆæª¢æŸ¥åŠŸèƒ½æ¢å¾©
   - è‡¨æ™‚ç›®éŒ„å‰µå»ºæ­£å¸¸
   - å‘½ä»¤åŸ·è¡ŒåŠŸèƒ½æ­£å¸¸
   - æ¸…ç†åŠŸèƒ½æ­£å¸¸

2. **éŒ¯èª¤è™•ç†æ”¹å–„**
   - æ›´å¥½çš„éŒ¯èª¤æ•ç²
   - æ¸…æ™°çš„éŒ¯èª¤è¨Šæ¯
   - å„ªé›…çš„é™ç´šè™•ç†

### âœ… é–‹ç™¼é«”é©—æ”¹å–„

1. **é è¨­é–‹å•Ÿ F12**
   - æ–¹ä¾¿ debug å’Œé–‹ç™¼
   - å³æ™‚æŸ¥çœ‹ Console è¨Šæ¯
   - ç›£æ§éŒ¯èª¤å’Œè­¦å‘Š

2. **éŒ¯èª¤è™•ç†æ¸¬è©¦**
   - è‡ªå‹•æª¢æ¸¬å¸¸è¦‹å•é¡Œ
   - æä¾›ä¿®å¾©å»ºè­°
   - ç›£æ§æ‡‰ç”¨ç¨‹å¼å¥åº·ç‹€æ…‹

## ğŸ§ª æ¸¬è©¦é©—è­‰

### ä¿®å¾©é©—è­‰æ¸…å–®

- âœ… **preload.js è¼‰å…¥æˆåŠŸ** - ä¸å†æœ‰æ¨¡çµ„è¼‰å…¥éŒ¯èª¤
- âœ… **FFmpeg åŠŸèƒ½æ­£å¸¸** - å¯ä»¥æª¢æŸ¥å¯ç”¨æ€§å’ŒåŸ·è¡Œå‘½ä»¤
- âœ… **CSP è­¦å‘Šæ¶ˆé™¤** - ä¸å†æœ‰å®‰å…¨è­¦å‘Š
- âœ… **IPC é€šè¨Šæ­£å¸¸** - ä¸»ç¨‹åºèˆ‡æ¸²æŸ“ç¨‹åºé€šè¨Šé †æš¢
- âœ… **F12 é è¨­é–‹å•Ÿ** - æ–¹ä¾¿é–‹ç™¼å’Œ debug

### æ¸¬è©¦è…³æœ¬

1. **éŒ¯èª¤è™•ç†æ¸¬è©¦** - `test-error-handling.js`
   - ç›£æ§æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•éŒ¯èª¤
   - æª¢æ¸¬ Console è­¦å‘Šå’ŒéŒ¯èª¤
   - åˆ†æå¸¸è¦‹å•é¡Œæ¨¡å¼

2. **åŠŸèƒ½æ¸¬è©¦** - ç¾æœ‰æ¸¬è©¦å¥—ä»¶
   - æ‰€æœ‰åŸæœ‰åŠŸèƒ½æ­£å¸¸
   - æ–°çš„ IPC åŠŸèƒ½æ­£å¸¸
   - æ•ˆèƒ½æ²’æœ‰æ˜é¡¯å½±éŸ¿

## ğŸŠ ä½¿ç”¨å»ºè­°

### é–‹ç™¼æ¨¡å¼

```bash
# å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼ï¼ˆé è¨­é–‹å•Ÿ F12ï¼‰
npm start

# é–‹ç™¼æ¨¡å¼
npm run dev

# ä¸é–‹å•Ÿé–‹ç™¼è€…å·¥å…·
npm run no-devtools
```

### Debug æŠ€å·§

1. **æª¢æŸ¥ IPC é€šè¨Š**
   ```javascript
   // åœ¨ Console ä¸­æ¸¬è©¦
   await window.electronAPI.ffmpeg.checkAvailability()
   ```

2. **ç›£æ§éŒ¯èª¤**
   ```javascript
   // è¨­å®šéŒ¯èª¤ç›£è½
   window.addEventListener('error', (e) => {
     console.error('å…¨åŸŸéŒ¯èª¤:', e.error);
   });
   ```

3. **æª¢æŸ¥ CSP è¨­å®š**
   - åœ¨ Network é¢æ¿æŸ¥çœ‹ CSP å ±å‘Š
   - ç¢ºä¿æ²’æœ‰ CSP é•è¦

## ğŸ‰ ç¸½çµ

### ä¿®å¾©æˆæœ

âœ… **å®Œå…¨è§£æ±º require éŒ¯èª¤** - æ¶æ§‹é‡æ–°è¨­è¨ˆ  
âœ… **FFmpeg åŠŸèƒ½æ¢å¾©** - é€šé IPC å®‰å…¨èª¿ç”¨  
âœ… **æ¶ˆé™¤å®‰å…¨è­¦å‘Š** - æ·»åŠ  CSP ä¿è­·  
âœ… **æå‡é–‹ç™¼é«”é©—** - F12 é è¨­é–‹å•Ÿ  
âœ… **ç¬¦åˆæœ€ä½³å¯¦è¸** - Electron å®‰å…¨æ¶æ§‹  

### æ¶æ§‹å„ªå‹¢

ğŸ”’ **æ›´å®‰å…¨** - ç¬¦åˆ Electron å®‰å…¨æ¨¡å‹  
ğŸš€ **æ›´ç©©å®š** - éŒ¯èª¤è™•ç†æ›´å®Œå–„  
ğŸ”§ **æ›´æ˜“ç¶­è­·** - æ¸…æ™°çš„å‰å¾Œç«¯åˆ†é›¢  
ğŸ“Š **æ›´æ˜“ç›£æ§** - å®Œå–„çš„éŒ¯èª¤æª¢æ¸¬  

**ç’å¨œç¾åœ¨å¯ä»¥å®‰å¿ƒä½¿ç”¨æ‰€æœ‰åŠŸèƒ½ï¼Œä¸æœƒå†é‡åˆ° require éŒ¯èª¤å’Œå®‰å…¨è­¦å‘Šï¼** ğŸŒ™âœ¨

---

**ä¿®å¾©å®Œæˆæ™‚é–“ï¼š** 2025-09-07  
**ä¿®å¾©æª”æ¡ˆï¼š** `src/preload.js`, `src/main.js`, `src/ffmpeg-handler.js`, `src/index.html`  
**æ¶æ§‹æ”¹é€²ï¼š** IPC é€šè¨Šæ¨¡å¼ï¼Œå®‰å…¨æ€§æå‡  
**æ¸¬è©¦ç‹€æ…‹ï¼š** âœ… éŒ¯èª¤å·²ä¿®å¾©
